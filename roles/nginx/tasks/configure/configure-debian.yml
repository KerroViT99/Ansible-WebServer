---
- name: Removing the default Nginx config
  file:
    state: absent
    path: "/etc/nginx/nginx.conf"

- name: Configure Nginx (without HTTPS)
  copy:
    src: "files/nginx_http.conf"
    dest: "/etc/nginx/nginx.conf"
  when: https_enabled == "no"

- name: Configure Nginx (with HTTPS)
  copy:
    src: "files/nginx_https.conf"
    dest: "/etc/nginx/nginx.conf"
  when: https_enabled == "yes"

- name: Creating a directory for additional configuration files
  file:
    path: "/etc/nginx/ansiblewebserver.configs"
    state: directory

- name: Copying security.conf (without HTTPS)
  copy:
    src: "files/security_http.conf"
    dest: "/etc/nginx/ansiblewebserver.configs/security.conf"
  when: https_enabled == "no"

- name: Copying security.conf (with HTTPS)
  copy:
    src: "files/security_https.conf"
    dest: "/etc/nginx/ansiblewebserver.configs/security.conf"
  when: https_enabled == "yes"

- name: Generate Diffie-Hellman parameters
  openssl_dhparam:
    path: "/etc/nginx/dhparam.pem"
    size: 2048
    force: True
  when: https_enabled == "yes"

- name: Copying general.conf
  copy:
    src: "files/general.conf"
    dest: "/etc/nginx/ansiblewebserver.configs/general.conf"

- name: Copying proxy.conf
  copy:
    src: "files/proxy.conf"
    dest: "/etc/nginx/ansiblewebserver.configs/proxy.conf"

- name: Create host (without HTTPS)
  template:
    src: "templates/domain_http.conf.j2"
    dest: "/etc/nginx/sites-available/{{ domain_name }}.conf"
  when: https_enabled == "no"

- name: Create host (with HTTPS)
  template:
    src: "templates/domain_https.conf.j2"
    dest: "/etc/nginx/sites-available/{{ domain_name }}.conf"
  when: https_enabled == "yes"

- name: Enable host
  file:
    src: "/etc/nginx/sites-available/{{ domain_name }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ domain_name}}.conf"
    state: link
  notify: Restart Nginx (Debian)
